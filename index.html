<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riigihanke Andmed</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<<<<<<< Updated upstream
    <link href="output.css" rel="stylesheet">
    <style>
        .dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }
        .dark-mode .container {
            background-color: #1e1e1e;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
        }
        .dark-mode input, .dark-mode select, .dark-mode button {
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #555;
        }
        .dark-mode button {
            background-color: #007bff;
        }
        .dark-mode button:hover {
            background-color: #0056b3;
        }
        .dark-mode th {
            background-color: #007bff;
        }
        .dark-mode td {
            background-color: #2e2e2e;
        }
        .dark-mode tr:nth-child(even) {
            background-color: #3a3a3a;
        }
        .dark-mode .delete-button {
            background-color: #dc3545;
        }
        .dark-mode .delete-button:hover {
            background-color: #c82333;
        }
        .dark-mode .edit-button {
            background-color: #ffc107;
        }
        .dark-mode .edit-button:hover {
            background-color: #e0a800;
        }
    </style>
=======
    <link href="src/output.css" rel="stylesheet">

>>>>>>> Stashed changes
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <!-- Modern Navbar with Dark Mode Toggle -->
    <header class="bg-gray-200 text-black p-4 shadow-md w-full">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold ml-4">Riigihanke andmed</h1>
            <nav class="flex space-x-6">
                <a href="#" id="showForm" class="hover:text-gray-600 transition">Tööriist</a>
                <a href="#" id="showSavedSearches" class="hover:text-gray-600 transition">Hanked</a>
                <a href="#" id="showHistory" class="hover:text-gray-600 transition">Ajalugu</a>
                <a href="#" id="settingsButton" class="hover:text-gray-600 transition">Sätted</a>
                <a href="#" onclick="toggleDashboard()" class="hover:text-gray-600 transition">Toggle 3</a>
                <label class="flex items-center cursor-pointer">
                    <span class="mr-2">Dark Mode</span>
                    <input type="checkbox" id="darkModeToggle" class="hidden">
                    <div class="w-10 h-5 bg-gray-500 rounded-full p-1 flex items-center relative">
                        <div class="w-4 h-4 bg-white rounded-full shadow-md transition transform"></div>
                    </div>
                </label>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-6 pt-32">
        <div id="dashboard" class="tab-content hidden">
            <!-- Dashboard content goes here -->
        </div>
        <div class="nav hidden">
            <div class="relative inline-block text-left">
                <button id="dropdownButton" class="bg-blue-500 text-white px-4 py-2 rounded flex items-center hover:bg-blue-600 transition transform hover:scale-105" aria-haspopup="true" aria-expanded="true">
                    <i class="fas fa-bars mr-2"></i> Menüü
                </button>
                <div id="dropdownMenu" class="hidden origin-top-left absolute left-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5">
                    <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="dropdownButton">
                        <button id="showForm" class="block px-4 py-2 text-sm text-black-700 hover:bg-gray-100 w-full text-left hover:bg-blue-600 transition transform hover:scale-105" role="menuitem">
                            <i class="fas fa-tools mr-2"></i> Tööriist
                        </button>
                        <button id="showSavedSearches" class="block px-4 py-2 text-sm text-black-700 hover:bg-gray-100 w-full text-left hover:bg-blue-600 transition transform hover:scale-105" role="menuitem">
                            <i class="fas fa-folder-open mr-2"></i> Hanked
                        </button>
                        <button id="showHistory" class="block px-4 py-2 text-sm text-black-700 hover:bg-gray-100 w-full text-left hover:bg-blue-600 transition transform hover:scale-105" role="menuitem">
                            <i class="fas fa-history mr-2"></i> Ajalugu
                        </button>
                        <button id="settingsButton" class="block px-4 py-2 text-sm text-black-700 hover:bg-gray-100 w-full text-left hover:bg-blue-600 transition transform hover:scale-105" role="menuitem">
                            <i class="fas fa-cog mr-2"></i> Sätted
                        </button>
                        <button id="toggleDarkMode" class="block px-4 py-2 text-sm text-black-700 hover:bg-gray-100 w-full text-left hover:bg-blue-600 transition transform hover:scale-105" role="menuitem">
                            <i class="fas fa-moon mr-2"></i> Dark Mode
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="currentDateTime" class="absolute bottom-2 right-2 bg-white p-2 rounded shadow text-gray-800"></div>
        <div id="toolTab" class="flex space-x-4">
            <div class="container bg-white p-6 rounded shadow max-w-2xl" id="formContainer">
                <h2 class="text-2xl font-bold text-center mb-4">Sisesta andmed</h2>
                <form id="procurementForm" class="space-y-4">
                    <div>
                        <label for="name" class="block text-gray-700">Riigihanke nimetus:</label>
                        <input type="text" id="name" name="name" class="w-full p-2 border rounded" required>
                    </div>
                    <div>
                        <label for="cost" class="block text-gray-700">Riigihanke maksumus:</label>
                        <input type="number" id="cost" name="cost" class="w-full p-2 border rounded" required>
                    </div>
                    <div>
                        <label for="procedureType" class="block text-gray-700">Riigihanke menetlusliik:</label>
                        <select id="procedureType" name="procedureType" class="w-full p-2 border rounded" required>
                            <option value="Avatud hankemenetlus asjade hankelepingu sõlmimiseks">Avatud hankemenetlus asjade hankelepingu sõlmimiseks</option>
                            <option value="Avatud hankemenetlus teenuste hankelepingu sõlmimiseks">Avatud hankemenetlus teenuste hankelepingu sõlmimiseks</option>
                            <option value="Avatud hankemenetlus ehitustööde hankelepingu sõlmimiseks">Avatud hankemenetlus ehitustööde hankelepingu sõlmimiseks</option>
                            <option value="Piiratud hankemenetlus teenuste hankelepingu sõlmimiseks">Piiratud hankemenetlus teenuste hankelepingu sõlmimiseks</option>
                            <option value="Piiratud hankemenetlus asjade hankelepingu sõlmimiseks">Piiratud hankemenetlus asjade hankelepingu sõlmimiseks</option>
                            <option value="Piiratud hankemenetlus ehitustööde hankelepingu sõlmimiseks">Piiratud hankemenetlus ehitustööde hankelepingu sõlmimiseks</option>
                            <option value="Konkurentsipõhine läbirääkimistega hankemenetlus asjade hankelepingu sõlmimiseks">Konkurentsipõhine läbirääkimistega hankemenetlus asjade hankelepingu sõlmimiseks</option>
                            <option value="Konkurentsipõhine läbirääkimistega hankemenetlus teenuste hankelepingu sõlmimiseks">Konkurentsipõhine läbirääkimistega hankemenetlus teenuste hankelepingu sõlmimiseks</option>
                            <option value="Konkurentsipõhine läbirääkimistega hankemenetlus ehitustööde hankelepingu sõlmimiseks">Konkurentsipõhine läbirääkimistega hankemenetlus ehitustööde hankelepingu sõlmimiseks</option>
                            <option value="Innovatsioonipartnerlus asjade hankelepingu sõlmimiseks">Innovatsioonipartnerlus asjade hankelepingu sõlmimiseks</option>
                            <option value="Innovatsioonipartnerlus teenuste hankelepingu sõlmimiseks">Innovatsioonipartnerlus teenuste hankelepingu sõlmimiseks</option>
                            <option value="Võistlev dialoog asjade hankelepingu sõlmimiseks">Võistlev dialoog asjade hankelepingu sõlmimiseks</option>
                            <option value="Võistlev dialoog teenuste hankelepingu sõlmimiseks">Võistlev dialoog teenuste hankelepingu sõlmimiseks</option>
                            <option value="Võistlev dialoog ehitustööde hankelepingu sõlmimiseks">Võistlev dialoog ehitustööde hankelepingu sõlmimiseks</option>
                            <option value="Innovatsioonipartnerlus ehitustööde hankelepingu sõlmimiseks">Innovatsioonipartnerlus ehitustööde hankelepingu sõlmimiseks</option>
                            <option value="Kontsessioonimenetlus koos eraldi taotluse esitamisega">Kontsessioonimenetlus koos eraldi taotluse esitamisega</option>
                            <option value="Kontsessioonimenetlus ilma eraldi taotlust esitamata">Kontsessioonimenetlus ilma eraldi taotlust esitamata</option>
                            <option value="Sotsiaalteenuste erimenetlus">Sotsiaalteenuste erimenetlus</option>
                            <option value="Eriteenuste erimenetlus">Eriteenuste erimenetlus</option>
                        </select>
                    </div>
                    <div>
                        <label for="contractSigningDate" class="block text-gray-700">Lepingu allkirjastamise kuupäev:</label>
                        <input type="date" id="contractSigningDate" name="contractSigningDate" class="w-full p-2 border rounded" required>
                    </div>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded w-full flex items-center justify-center hover:bg-blue-600 transition transform hover:scale-105">
                        <i class="fas fa-calculator mr-2"></i> Arvuta menetlusaeg
                    </button>
                </form>
                <div class="flex space-x-2 mt-4">
                    <button id="clearFields" class="clear-button bg-red-500 text-white px-4 py-2 rounded flex-1 flex items-center justify-center hover:bg-red-600 transition transform hover:scale-105">
                        <i class="fas fa-broom mr-2"></i> Puhasta
                    </button>
                    <button id="saveFields" class="save-button bg-green-500 text-white px-4 py-2 rounded flex-1 flex items-center justify-center hover:bg-green-600 transition transform hover:scale-105">
                        <i class="fas fa-save mr-2"></i> Salvesta
                    </button>
                    <button id="refreshFields" class="refresh-button bg-yellow-500 text-black px-4 py-2 rounded flex-1 flex items-center justify-center hover:bg-yellow-600 transition transform hover:scale-105">
                        <i class="fas fa-sync-alt mr-2"></i> Uuenda
                    </button>
                </div>
            </div>
            <div class="container bg-white p-6 rounded shadow max-w-2xl hidden" id="resultContainer">
                <div id="result" class="result-card"></div>
            </div>
        </div>

        <!-- The saved searches container is hidden by default and will be shown when the user clicks the "Show Saved Searches" button -->
        <div class="container bg-white p-6 rounded shadow text-m hidden" id="savedSearchesContainer">
            <h2 class="text-2xl font-bold text-center mb-4">Salvestatud Hanked</h2>
            <table class="w-full border-collapse shadow-lg rounded-lg overflow-hidden">
                <thead>
                    <tr>
                        <th class="p-3">Nimi</th>
                        <th class="p-3">Menetlusliik</th>
                        <th class="p-3">Maksumus</th>
                        <th class="p-3">Menetlusaeg</th>
                        <th class="p-3">Taotluse Kuupäev</th>
                        <th class="p-3">Allkirjastamise Kuupäev</th>
                        <th class="p-3">Muuda</th>
                        <th class="p-3">Kustuta</th>
                    </tr>
                </thead>
                <tbody id="savedSearchesTableBody">
                    <!-- Saved searches will be inserted here -->
                </tbody>
            </table>
            <button id="saveToExcel" class="bg-green-500 text-white px-4 py-2 rounded mt-4 hover:bg-green-600 transition transform hover:scale-105">Salvesta Excelisse</button>
            <button id="saveHPExcel" class="bg-blue-500 text-white px-4 py-2 rounded mt-4 hover:bg-blue-600 transition transform hover:scale-105">HP Näidis</button>
            <!-- Button to Show Chart -->
            <button onclick="toggleChartBtn" class="bg-blue-500 text-white px-4 py-2 rounded mt-4 hover:bg-blue-600 transition transform hover:scale-105">
                Näita Graafikut
            </button>

            <!-- Chart Container (Initially Hidden) -->
            <div id="chartContainer" class="hidden mt-4 w-full max-w-lg mx-auto">
                <canvas id="procurementChart" class="w-full"></canvas>
            </div>
        </div>
        <!-- Settings Container -->
        <div class="container bg-white p-6 rounded-lg shadow-lg max-w-2xl hidden" id="settingsContainer">
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-800">⚙️ Seaded</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Form Section -->
                <form id="settingsForm" class="space-y-6 bg-gray-50 p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-800">📑 Menetlusliigi sätted</h3>

                    <div class="relative">
                        <label for="documentPreparationDays" class="block text-gray-700 mb-1">📄 Riigihanke alusdokumentide koostamine (päevad):</label>
                        <input type="number" id="documentPreparationDays" name="documentPreparationDays"
                            class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Sisesta päevad" required>
                    </div>

                    <div class="relative">
                        <label for="offerEvaluationDays" class="block text-gray-700 mb-1">🧐 Pakkumuste hindamine (päevad):</label>
                        <input type="number" id="offerEvaluationDays" name="offerEvaluationDays"
                            class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Sisesta päevad" required>
                    </div>

                    <div class="relative">
                        <label for="decisionDays" class="block text-gray-700 mb-1">✅ Vastavaks ja edukaks tunnistamise otsus (päevad):</label>
                        <input type="number" id="decisionDays" name="decisionDays"
                            class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Sisesta päevad" required>
                    </div>

                    <div class="relative">
                        <label for="bidderEvaluationDays" class="block text-gray-700 mb-1">📊 Pakkujate hindamine (päevad):</label>
                        <input type="number" id="bidderEvaluationDays" name="bidderEvaluationDays"
                            class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Sisesta päevad" required>
                    </div>

                    <div class="relative">
                        <label for="successfulBidderDays" class="block text-gray-700 mb-1">🏆 Eduka kõrvaldamata jätmine ja kval (päevad):</label>
                        <input type="number" id="successfulBidderDays" name="successfulBidderDays"
                            class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Sisesta päevad" required>
                    </div>

                    <div class="relative">
                        <label for="waitingPeriodDays" class="block text-gray-700 mb-1">⏳ Ooteaeg (päevad):</label>
                        <input type="number" id="waitingPeriodDays" name="waitingPeriodDays"
                            class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Sisesta päevad" required>
                    </div>

                    <button type="submit"
                        class="w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition transform hover:scale-105">
                        💾 Salvesta
                    </button>
                </form>

                <!-- Procedure Type Selection -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">🛠️ Menetlusliigid</h3>
                    <select id="procedureTypeSelect"
                        class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <!-- Options will be populated dynamically -->
                    </select>
                    <div id="procedureTypeSettings" class="mt-4 space-y-4">
                        <!-- Procedure type settings will be displayed here -->
                    </div>
                    <button id="addProcedureTypeButton"
                        class="w-full bg-green-500 text-white p-3 rounded-lg mt-4 hover:bg-green-600 transition transform hover:scale-105">
                        ➕ Lisa Menetlusliik
                    </button>
                </div>
            </div>
        </div>
        </div>
        <div class="container bg-white p-6 rounded shadow text-m hidden" id="historyContainer">
            <h2 class="text-2xl font-bold text-center mb-4">Arvutuste Ajalugu</h2>
            <div class="filter-container mb-4">
                <label for="filterByDate" class="block text-gray-700">Filtreeri kuupäeva järgi:</label>
                <select id="filterByDate" class="w-full p-2 border rounded">
                    <option value="all">Kõik</option>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            <table class="w-full border-collapse table-auto">
                <thead>
                    <tr>
                        <th class="border p-2 bg-blue-500 text-white">Nimi</th>
                        <th class="border p-2 bg-blue-500 text-white">Menetlusliik</th>
                        <th class="border p-2 bg-blue-500 text-white">Maksumus</th>
                        <th class="border p-2 bg-blue-500 text-white">Menetlusaeg</th>
                        <th class="border p-2 bg-blue-500 text-white">Taotluse Kuupäev</th>
                        <th class="border p-2 bg-blue-500 text-white">Allkirjastamise Kuupäev</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <!-- History entries will be inserted here -->
                </tbody>
            </table>
        </div>
        <div class="password-prompt hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded shadow w-80 text-center" id="passwordPrompt">
            <h3 class="text-xl font-bold mb-4">Enter Password</h3>
            <input type="password" id="passwordInput" class="w-full p-2 border-b-2 border-gray-300 focus:border-blue-500 outline-none mb-4" placeholder="Password">
            <div class="flex justify-center space-x-2">
                <button id="passwordSubmit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition transform hover:scale-105">Submit</button>
                <button id="passwordClose" class="close-button bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition transform hover:scale-105">Close</button>
            </div>
            <p class="error-message text-red-500 font-bold mt-4 hidden" id="passwordError">Incorrect password. Please try again.</p>
        </div>

        <!-- Modern Table -->
        <table id="recentCalculationsTable" class="w-full border-collapse shadow-lg rounded-lg overflow-hidden mt-4 hidden">
            <thead class="bg-blue-500 text-white">
            <tr>
                <th class="p-3">Nimi</th>
                <th class="p-3">Menetlusliik</th>
                <th class="p-3">Maksumus</th>
                <th class="p-3">Menetlusaeg</th>
                <th class="p-3">Taotluse Kuupäev</th>
            </tr>
            </thead>
            <tbody id="recentCalculations">
            <!-- Last 3 calculations will be dynamically inserted here -->
            </tbody>
        </table>

        <!-- Notification System -->
        <div id="notification" class="fixed bottom-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-md hidden">
            ✅ !
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script>
        // Utility function for formatting dates to "dd.mm.yyyy"
        function formatDate(date) {
            const d = new Date(date);
            
            if (isNaN(d.getTime())) {
                console.error("Invalid date:", date);
                return "Invalid date";  // Prevents errors
            }

            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();

            return `${day}.${month}.${year}`;
        }

        const procedureData = {
            "Lihthankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 10, piirmäär: 60000 },
            "Lihthankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 10, piirmäär: 60000 },
            "Lihthankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 15, piirmäär: 150000 },
            "Avatud hankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 15, piirmäär: 60000 },
            "Avatud hankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 15, piirmäär: 60000 },
            "Avatud hankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 15, piirmäär: 150000 },
            "Piiratud hankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
            "Piiratud hankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
            "Piiratud hankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 150000 },
            "Konkurentsipõhine läbirääkimistega hankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
            "Konkurentsipõhine läbirääkimistega hankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
            "Konkurentsipõhine läbirääkimistega hankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 25, piirmäär: 150000 },
            "Innovatsioonipartnerlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
            "Innovatsioonipartnerlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
            "Võistlev dialoog asjade hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
            "Võistlev dialoog teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
            "Võistlev dialoog ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 25, piirmäär: 150000 },
            "Innovatsioonipartnerlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 25, piirmäär: 150000 },
            "Kontsessioonimenetlus koos eraldi taotluse esitamisega": { taotlusteAeg: 30, pakkumusteAeg: 17, piirmäär: 300000 },
            "Kontsessioonimenetlus ilma eraldi taotlust esitamata": { taotlusteAeg: 0, pakkumusteAeg: 30, piirmäär: 300000 },
            "Sotsiaalteenuste erimenetlus": { taotlusteAeg: 0, pakkumusteAeg: 10, piirmäär: 300000 },
            "Eriteenuste erimenetlus": { taotlusteAeg: 0, pakkumusteAeg: 10, piirmäär: 60000 },
        };

        const internationalProcedureData = {
            "Avatud hankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 30, piirmäär: 143000 },
            "Avatud hankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 30, piirmäär: 143000 },
            "Avatud hankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 45, piirmäär: 5538000 },
            "Piiratud hankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
            "Piiratud hankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
            "Piiratud hankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 5538000 },
            "Konkurentsipõhine läbirääkimistega hankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
            "Konkurentsipõhine läbirääkimistega hankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
            "Konkurentsipõhine läbirääkimistega hankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 5538000 },
            "Innovatsioonipartnerlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
            "Innovatsioonipartnerlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
            "Innovatsioonipartnerlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 5538000 },
            "Võistlev dialoog asjade hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
            "Võistlev dialoog teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
            "Võistlev dialoog ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 5538000 },
            "Kontsessioonimenetlus koos eraldi taotluse esitamisega": { taotlusteAeg: 30, pakkumusteAeg: 17, piirmäär: 5538000 },
            "Kontsessioonimenetlus ilma eraldi taotlust esitamata": { taotlusteAeg: 0, pakkumusteAeg: 30, piirmäär: 5538000 },
            "Sotsiaalteenuste erimenetlus": { taotlusteAeg: 0, pakkumusteAeg: 10, piirmäär: 750000 },
            "Eriteenuste erimenetlus": { taotlusteAeg: 0, pakkumusteAeg: 10, piirmäär: 750000 }
        };

        const defaultSettings = {
            documentPreparationDays: 10,
            offerEvaluationDays: 5,
            decisionDays: 3,
            bidderEvaluationDays: 3,
            successfulBidderDays: 3,
            waitingPeriodDays: 14
        };

        let settings = { ...defaultSettings };

        const correctPassword = '123';
        let passwordValidUntil = null;

        function showPasswordPrompt(callback) {
            const now = new Date();
            if (passwordValidUntil && now < passwordValidUntil) {
                callback();
                return;
            }

            const passwordPrompt = document.getElementById('passwordPrompt');
            const passwordInput = document.getElementById('passwordInput');
            const passwordError = document.getElementById('passwordError');
            passwordPrompt.classList.remove('hidden');
            passwordInput.value = '';
            passwordError.classList.add('hidden');

            document.getElementById('passwordSubmit').onclick = function() {
                if (passwordInput.value === correctPassword) {
                    passwordPrompt.classList.add('hidden');
                    passwordValidUntil = new Date(now.getTime() + 10 * 60000); // 10 minutes from now
                    callback();
                } else {
                    passwordError.classList.remove('hidden');
                }
            };

            document.getElementById('passwordClose').onclick = function() {
                passwordPrompt.classList.add('hidden');
            };
        }

        document.getElementById('settingsButton').addEventListener('click', function() {
            closeAllTabs();
            document.getElementById('settingsContainer').classList.remove('hidden');
            loadSettings();
            loadProcedureTypes();
            setActiveTab(this);
        });

        document.getElementById('settingsForm').addEventListener('submit', function(event) {
            event.preventDefault();
            settings.documentPreparationDays = parseInt(document.getElementById('documentPreparationDays').value);
            settings.offerEvaluationDays = parseInt(document.getElementById('offerEvaluationDays').value);
            settings.decisionDays = parseInt(document.getElementById('decisionDays').value);
            settings.bidderEvaluationDays = parseInt(document.getElementById('bidderEvaluationDays').value);
            settings.successfulBidderDays = parseInt(document.getElementById('successfulBidderDays').value);
            settings.waitingPeriodDays = parseInt(document.getElementById('waitingPeriodDays').value);
        });

        document.getElementById('addProcedureTypeButton').addEventListener('click', function() {
            addProcedureType();
        });

        document.getElementById('procedureTypeSelect').addEventListener('change', function() {
            const selectedType = this.value;
            loadProcedureTypeSettings(selectedType);
        });

        function loadSettings() {
            document.getElementById('documentPreparationDays').value = settings.documentPreparationDays;
            document.getElementById('offerEvaluationDays').value = settings.offerEvaluationDays;
            document.getElementById('decisionDays').value = settings.decisionDays;
            document.getElementById('bidderEvaluationDays').value = settings.bidderEvaluationDays;
            document.getElementById('successfulBidderDays').value = settings.successfulBidderDays;
            document.getElementById('waitingPeriodDays').value = settings.waitingPeriodDays;
        }

        function saveSettings() {
            localStorage.setItem('procurementSettings', JSON.stringify(settings));
        }

        function loadSavedSettings() {
            const savedSettings = localStorage.getItem('procurementSettings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
            }
        }

        function loadProcedureTypes() {
            const select = document.getElementById('procedureTypeSelect');
            select.innerHTML = '';
            Object.keys(procedureData).forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                select.appendChild(option);
            });
            if (select.options.length > 0) {
                loadProcedureTypeSettings(select.options[0].value);
            }
        }

        function loadProcedureTypeSettings(type) {
            const procedure = procedureData[type];
            const container = document.getElementById('procedureTypeSettings');
            container.innerHTML = `
                <div class="procedure-type">
                    <label for="procedureTypeName" class="block text-gray-700">Menetlusliik:</label>
                    <input type="text" id="procedureTypeName" value="${type}" required><br><br>
                    <label for="requestDays" class="block text-gray-700">Taotluste esitamise päevad:</label>
                    <input type="number" id="requestDays" value="${procedure.taotlusteAeg}" required><br><br>
                    <label for="offerDays" class="block text-gray-700">Pakkumuste esitamise päevad:</label>
                    <input type="number" id="offerDays" value="${procedure.pakkumusteAeg}" required><br><br>
                    <label for="useInternationalThreshold" class="block text-gray-700">Kasuta rahvusvahelisi tähtaegu:</label>
                    <input type="checkbox" id="useInternationalThreshold" ${procedure.useInternational ? 'checked' : ''} onchange="toggleInternationalThreshold('${type}')"><br><br>
                    <button onclick="deleteProcedureType('${type}')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition transform hover:scale-105">Kustuta</button>
                    <button onclick="saveProcedureType('${type}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition transform hover:scale-105">Salvesta</button>
                </div>
            `;
        }

        function addProcedureType() {
            const container = document.getElementById('procedureTypeSettings');
            container.innerHTML = `
                <div class="procedure-type">
                    <label for="procedureTypeName" class="block text-gray-700">Menetlusliik:</label>
                    <input type="text" id="procedureTypeName" required><br><br>
                    <label for="requestDays" class="block text-gray-700">Taotluste esitamise päevad:</label>
                    <input type="number" id="requestDays" required><br><br>
                    <label for="offerDays" class="block text-gray-700">Pakkumuste esitamise päevad:</label>
                    <input type="number" id="offerDays" required><br><br>
                    <label for="useInternationalThreshold" class="block text-gray-700">Kasuta rahvusvahelisi tähtaegu:</label>
                    <input type="checkbox" id="useInternationalThreshold" onchange="toggleInternationalThreshold()"><br><br>
                    <button onclick="saveNewProcedureType()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition transform hover:scale-105">Salvesta</button>
                </div>
            `;
        }

        function toggleInternationalThreshold(type) {
            const useInternational = document.getElementById('useInternationalThreshold').checked;
            const procedure = useInternational ? internationalProcedureData[type] : procedureData[type];
            document.getElementById('requestDays').value = procedure.taotlusteAeg;
            document.getElementById('offerDays').value = procedure.pakkumusteAeg;
        }

        function deleteProcedureType(type) {
            delete procedureData[type];
            loadProcedureTypes();
            saveSettings();
        }

        function saveProcedureType(oldType) {
            const newType = document.getElementById('procedureTypeName').value;
            const requestDays = parseInt(document.getElementById('requestDays').value);
            const offerDays = parseInt(document.getElementById('offerDays').value);
            const useInternational = document.getElementById('useInternationalThreshold').checked;
            delete procedureData[oldType];
            procedureData[newType] = { taotlusteAeg: requestDays, pakkumusteAeg: offerDays, piirmäär: 60000, useInternational }; // Default piirmäär
            loadProcedureTypes();
            saveSettings();
        }

        function saveNewProcedureType() {
            const newType = document.getElementById('procedureTypeName').value;
            const requestDays = parseInt(document.getElementById('requestDays').value);
            const offerDays = parseInt(document.getElementById('offerDays').value);
            const useInternational = document.getElementById('useInternationalThreshold').checked;
            procedureData[newType] = { taotlusteAeg: requestDays, pakkumusteAeg: offerDays, piirmäär: 60000, useInternational }; // Default piirmäär
            loadProcedureTypes();
            saveSettings();
        }

        loadSavedSettings();

        class PublicProcurement {
            constructor(name, cost, procedureType, contractSigningDate) {
                // Ensure the date is valid before any conversion logic
                if (!contractSigningDate || isNaN(new Date(contractSigningDate).getTime())) {
                    console.error("Invalid contract signing date:", contractSigningDate);
                    this.contractSigningDate = null; // Avoid breaking further calculations
                } else {
                    // Convert dd.mm.yyyy to YYYY-MM-DD if necessary
                    if (typeof contractSigningDate === "string" && contractSigningDate.includes(".")) {
                        const parts = contractSigningDate.split(".");
                        if (parts.length === 3) {
                            contractSigningDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                        }
                    }
                    this.contractSigningDate = new Date(contractSigningDate);
                }

                this.name = name;
                this.cost = cost;
                this.procedureType = procedureType;
                this.contractSigningDate = new Date(contractSigningDate); null;
                this.procedureDuration = this.calculateProcedureDuration();
                this.procedureDetails = this.calculateProcedureDetails();
                this.requestSubmissionDate = this.calculateRequestSubmissionDate();
            }

            calculateProcedureDuration() {
                const procedure = procedureData[this.procedureType];
                const internationalProcedure = internationalProcedureData[this.procedureType];
                const internationalThreshold = internationalProcedure.piirmäär;

                let duration = 0;

                if (this.cost > internationalThreshold || procedure.useInternational) {
                    duration += internationalProcedure.taotlusteAeg + internationalProcedure.pakkumusteAeg;
                } else {
                    duration += procedure.taotlusteAeg + procedure.pakkumusteAeg;
                }

                duration += settings.documentPreparationDays;
                duration += settings.offerEvaluationDays;
                duration += settings.decisionDays;
                duration += settings.bidderEvaluationDays;
                duration += settings.successfulBidderDays;
                duration += settings.waitingPeriodDays;

                return duration;
            }

            calculateProcedureDetails() {
                const procedure = procedureData[this.procedureType];
                const internationalProcedure = internationalProcedureData[this.procedureType];
                const internationalThreshold = internationalProcedure.piirmäär;
                let taotlusteAeg, pakkumusteAeg;

                if (this.cost > internationalThreshold || procedure.useInternational) {
                    taotlusteAeg = internationalProcedure.taotlusteAeg;
                    pakkumusteAeg = internationalProcedure.pakkumusteAeg;
                } else {
                    taotlusteAeg = procedure.taotlusteAeg;
                    pakkumusteAeg = procedure.pakkumusteAeg;
                }

                const details = [
                    { step: "Riigihanke alusdokumentide koostamine", days: ` ${settings.documentPreparationDays} päeva` },
                    { step: "Taotluste esitamine RHRis", days: taotlusteAeg ? `${taotlusteAeg} päeva` : "Ei kohaldu" },
                    { step: "Pakkumuste esitamine RHRis", days: pakkumusteAeg ? `${pakkumusteAeg} päeva` : "Ei kohaldu" },
                    { step: "Hindamine 1", days: `${settings.offerEvaluationDays} päeva` },
                    { step: "Otsus 1", days: `${settings.decisionDays} päeva` },
                    { step: "Hindamine 2", days: `${settings.bidderEvaluationDays} päeva` },
                    { step: "Otsus 2", days: `${settings.successfulBidderDays} päeva` },
                    { step: "Ooteaeg", days: `${settings.waitingPeriodDays} päeva` }
                ];
                return details;
            }

            calculateRequestSubmissionDate() {
                // Step 1: Ensure contractSigningDate is in YYYY-MM-DD format
                if (typeof this.contractSigningDate === "string" && this.contractSigningDate.includes(".")) {
                    const parts = this.contractSigningDate.split(".");
                    if (parts.length === 3) {
                         this.contractSigningDate = typeof this.contractSigningDate === "string" ? `${parts[2]}-${parts[1]}-${parts[0]}` : this.contractSigningDate; // Convert dd.mm.yyyy → YYYY-MM-DD only if it's a string
                    }
                }

                // Step 2: Validate contractSigningDate before using it
                if (!this.contractSigningDate || isNaN(new Date(this.contractSigningDate).getTime())) {
                    console.error("Invalid contract signing date:", this.contractSigningDate);
                    return "Invalid date"; // Prevent further errors
                }

                // Step 3: Calculate the request submission date
                const submissionDate = new Date(this.contractSigningDate);
                if (!isNaN(this.procedureDuration)) {
                    submissionDate.setDate(submissionDate.getDate() - this.procedureDuration);
                if (isNaN(submissionDate.getTime())) {
                    console.error("Invalid submission date:", submissionDate);
                    return "Invalid date"; // Prevents errors
                }
                return submissionDate.toISOString().split('T')[0]; // Returns YYYY-MM-DD format
                    console.error("Invalid procedure duration:", this.procedureDuration);
                }

                return submissionDate.toISOString().split('T')[0]; // Returns YYYY-MM-DD format
            }

            generateHTML() {
                const detailsHTML = this.procedureDetails.map((detail, index) => `
                    <li class="flex justify-between items-center py-1">
                        <span class="w-3/4">${detail.step}:</span>
                        <span id="days-${index}" class="w-16 text-center font-medium whitespace-nowrap">${detail.days}</span>
                        <div class="flex gap-1 ml-6">
                            <button onclick="adjustDays(${index}, -1)" class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600 transition transform hover:scale-105">-</button>
                            <button onclick="adjustDays(${index}, 1)" class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600 transition transform hover:scale-105">+</button>

                        </div>
                    </li>
                `).join('');

                const errorMessage = new Date(this.requestSubmissionDate) < new Date() ? 
                    '<p class="error-message text-red-500 font-bold">NB! Oled hiljaks jäänud, palun tutvu menetlusele kuluva ajaga ja korrigeeri lepingu sõlmimise kuupäeva</p>' : '';

                return `
                    <div class="result-card bg-white p-6 rounded max-w-lg">
                        <h2 class="text-2xl font-bold text-black-500 mb-4">Riigihanke andmed</h2>
                        <p><strong>Riigihanke taotluse esitamise kuupäev:</strong> 
                            <span id="requestSubmissionDate">${formatDate(this.requestSubmissionDate)}</span>
                        </p>
                        ${errorMessage}
                        <p><strong>Nimi:</strong> ${this.name}</p>
                        <p><strong>Maksumus:</strong> ${this.cost}</p>
                        <p><strong>Riigihanke menetlusliik:</strong> ${this.procedureType}</p>
                        <p><strong>Lepingu allkirjastamise kuupäev:</strong> ${formatDate(this.contractSigningDate)}</p>
                        <p><strong>Eeldatav riigihanke menetlusaeg päevades:</strong> <span id="totalDuration">${this.procedureDuration}</span> päeva</p>
                        <ul class="list-none p-0">
                            ${detailsHTML}
                        </ul>
                    </div>
                `;
            }

            generateTableRow(index) {
                return `
                    <tr>
                        <td class="border p-2">${this.name}</td>
                        <td class="border p-2">${this.procedureType}</td>
                        <td class="border p-2">${this.cost}</td>
                        <td class="border p-2">${this.procedureDuration} päeva</td>
                        <td class="border p-2">${formatDate(this.requestSubmissionDate)}</td>
                        <td class="border p-2">${formatDate(this.contractSigningDate)}</td>
                        <td class="border p-2"><button class="edit-button bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 transition transform hover:scale-105" onclick="editSearch(${index})">Muuda</button></td>
                        <td class="border p-2"><button class="delete-button bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 transition transform hover:scale-105" onclick="deleteSearch(${index})">Kustuta</button></td>
                    </tr>
                `;
            }
        }

        function adjustDays(index, adjustment) {
            const daysElement = document.getElementById(`days-${index}`);
            if (!daysElement) {
                console.error(`Element with id days-${index} not found`);
                return;
            }

            let daysText = daysElement.innerText;
            let days = parseInt(daysText.match(/\d+/)?.[0] || "0", 10);  // Avoid NaN
            days += adjustment;
            daysElement.innerText = daysText.replace(/\d+/, days);

            // Update total duration
            const totalDurationElement = document.getElementById('totalDuration');
            if (totalDurationElement) {
                let totalDuration = parseInt(totalDurationElement.innerText || "0", 10);
                totalDuration += adjustment;
                totalDurationElement.innerText = totalDuration;
            } else {
                console.error('Element with id totalDuration not found');
            }

            // Store updated total duration in the PublicProcurement object
            const procurement = savedSearches.find(p => p.name === document.getElementById('name').value);
            if (procurement) {
                procurement.procedureDuration = parseInt(document.getElementById('totalDuration').innerText);
                procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();
                document.getElementById('requestSubmissionDate').innerText = formatDate(procurement.requestSubmissionDate);
            } else {
                console.error("Could not find procurement object for real-time update.");
            }
        }

        const savedSearches = [];
        const history = [];

        document.getElementById('procurementForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const name = document.getElementById('name').value;
            const cost = parseFloat(document.getElementById('cost').value);
            const procedureType = document.getElementById('procedureType').value;
            const contractSigningDate = document.getElementById('contractSigningDate').value;

            const procurement = new PublicProcurement(name, cost, procedureType, contractSigningDate);
            document.getElementById('result').innerHTML = procurement.generateHTML(); // Ensure the result is displayed
            
             // Show the result container
            document.getElementById('resultContainer').classList.remove('hidden');
            
            if (savedSearches.length < 15) {
                savedSearches.push(procurement);
                updateSavedSearchesTable();
            } else {
                alert("Maksimaalne salvestatud otsingute arv on 15.");
            }

            // Save to history
            if (history.length >= 500) {
                history.shift(); // Remove the oldest entry if history exceeds 500
            }
            history.push(procurement);
            saveHistory(); // Save history immediately
        });

        document.getElementById('clearFields').addEventListener('click', function() {
            document.getElementById('procurementForm').reset();
            document.getElementById('result').innerHTML = '';
            document.getElementById('resultContainer').classList.add('hidden'); // Hide the result container
        });

        document.getElementById('saveFields').addEventListener('click', function() {
            const name = document.getElementById('name').value;
            const cost = parseFloat(document.getElementById('cost').value);
            const procedureType = document.getElementById('procedureType').value;
            const contractSigningDate = document.getElementById('contractSigningDate').value;

            const procurement = new PublicProcurement(name, cost, procedureType, contractSigningDate);

            // Update procedure details with adjusted days
            procurement.procedureDetails.forEach((detail, index) => {
                const daysElement = document.getElementById(`days-${index}`);
                if (daysElement) {
                    let daysText = daysElement.innerText;
                    let match = daysText.match(/\d+/);
                    if (match) {
                        let days = parseInt(match[0]);
                        detail.days = `${days} päeva`;
                    } else {
                        console.error("No days found in text:", daysText);
                    }
                } else {
                    console.error("Element not found for index:", index);
                }
            })

            // Capture the adjusted procedureDuration value
            const totalDurationElement = document.getElementById('totalDuration');
            if (totalDurationElement) {
                procurement.procedureDuration = parseInt(totalDurationElement.innerText);
            } else {
                console.error("Total duration element not found");
            }

            procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();

            // Update the displayed result
            document.getElementById('result').innerHTML = procurement.generateHTML();

            // Save the updated procurement
            const existingIndex = savedSearches.findIndex(p => p.name === name);
            if (existingIndex !== -1) {
                savedSearches[existingIndex] = procurement;
            } else {
                if (savedSearches.length < 15) {
                    savedSearches.push(procurement);
                } else {
                    alert("Maksimaalne salvestatud otsingute arv on 15.");
                }
            }

            // Save to history
            if (history.length >= 500) {
                history.shift(); // Remove the oldest entry if history exceeds 500
            }
            history.push(procurement);
            saveHistory(); // Save history immediately
        });

        document.getElementById('refreshFields').addEventListener('click', function() {
            const procurement = new PublicProcurement(
                document.getElementById('name').value,
                parseFloat(document.getElementById('cost').value),
                document.getElementById('procedureType').value,
                document.getElementById('contractSigningDate').value
            );

            procurement.procedureDuration = parseInt(document.getElementById('totalDuration').innerText);
            procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();
            document.getElementById('requestSubmissionDate').innerText = formatDate(procurement.requestSubmissionDate);
            updateSavedSearchesTable();
        });

        document.getElementById('saveToExcel').addEventListener('click', function() {
            if (savedSearches.length === 0) {
                alert("Salvestatud otsinguid ei ole.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Nimi,Maksumus,Menetluse Tüüp,Lepingu Allkirjastamise Kuupäev,Menetlusele kuluv aeg\n";

            savedSearches.forEach(procurement => {
                const row = [
                    procurement.name,
                    procurement.cost,
                    procurement.procedureType,
                    formatDate(procurement.contractSigningDate),
                    procurement.procedureDuration
                ].join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "riigihanke_andmed.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        document.addEventListener("DOMContentLoaded", function () {
            // Kontrollime, kas "Salvesta Excelisse" nupp on olemas ja lisame sündmuse
            const saveToExcelBtn = document.getElementById('saveToExcel');
            if (saveToExcelBtn) {
                saveToExcelBtn.addEventListener('click', function () {
                    if (savedSearches.length === 0) {
                        alert("Salvestatud otsinguid ei ole.");
                        return;
                    }
        
                    let csvContent = "data:text/csv;charset=utf-8,";
                    csvContent += "Nimi,Maksumus,Menetluse Tüüp,Lepingu Allkirjastamise Kuupäev,Menetlusele kuluv aeg\n";
        
                    savedSearches.forEach(procurement => {
                        const row = [
                            procurement.name,
                            procurement.cost,
                            procurement.procedureType,
                            formatDate(procurement.contractSigningDate),
                            procurement.procedureDuration
                        ].join(",");
                        csvContent += row + "\n";
                    });
        
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "riigihanke_andmed.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
            }
            
        document.addEventListener('DOMContentLoaded', function () {
            const saveHPExcelBtn = document.getElementById('saveHPExcel');

            if (!window.savedSearches) {
                window.savedSearches = []; // Ensure it exists
            }
        
            if (saveHPExcelBtn) {
                saveHPExcelBtn.addEventListener('click', function () {
                    if (savedSearches.length === 0) {
                        alert("Salvestatud hanked puuduvad.");
                        return;
                    }
        
                    let hpData = [
                        ["Riigihanke eseme nimetus", "Riigihanke menetluse liik", "Eeldatav aeg (MM.YYYY)", "Maksumus KM-ta", "Kehtivusaeg", "Vastutav isik", "Tehniline vastutaja"]
                    ];
        
                    savedSearches.forEach(procurement => {
                        const formattedDate = procurement.requestSubmissionDate ? formatDateToMonthYear(procurement.requestSubmissionDate) : "Puudub";
                        hpData.push([
                            procurement.name || "Puudub",
                            procurement.procedureType || "Puudub",
                            formattedDate,
                            procurement.cost || "Puudub",
                            "",
                            "Hankekeskus",
                            "Asutus"
                        ]);
                    });
        
                    downloadExcel(hpData, "HP_Näidis.csv");
                });
            }
        
            function formatDateToMonthYear(dateString) {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return "Vale kuupäev";
                }
                return `${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
            }
        
            function downloadExcel(data, filename) {
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                data.forEach(row => {
                    csvContent += row.join(",") + "\n";
                });
        
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        document.getElementById('showForm').addEventListener('click', function() {
            closeAllTabs();
            document.getElementById('formContainer').classList.remove('hidden');
            setActiveTab(this);
        });

        document.getElementById('showSavedSearches').addEventListener('click', function() {
            closeAllTabs();
            document.getElementById('savedSearchesContainer').classList.remove('hidden');
            updateSavedSearchesTable();
            setActiveTab(this);
        });

        document.getElementById('showHistory').addEventListener('click', function() {
            closeAllTabs();
            document.getElementById('historyContainer').classList.remove('hidden');
            loadHistory();
            setActiveTab(this);
        });

        function setActiveTab(button) {
            const navButtons = document.querySelectorAll('.nav button');
            navButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        }

        function closeAllTabs() {
            document.getElementById("formContainer").classList.add("hidden");
            document.getElementById("savedSearchesContainer").classList.add("hidden");
            document.getElementById("historyContainer").classList.add("hidden");
            document.getElementById("settingsContainer").classList.add("hidden");
        }

        function updateSavedSearchesTable() {
            const tableBody = document.getElementById("savedSearchesTableBody");
            if (!tableBody) {
                console.error("❌ ERROR: 'savedSearchesTableBody' not found in the document.");
                return;
            }
        
            tableBody.innerHTML = "";
            savedSearches.forEach((procurement, index) => {
                tableBody.innerHTML += procurement.generateTableRow(index);
            });
        
            adjustTableColumns();
        }
        
            // Fix: Ensure correct ID for the second table
            const recentTableBody = document.getElementById('recentCalculations'); // ✅ Correct ID
            if (!recentTableBody) {
                console.warn("⚠️ Warning: 'recentCalculations' table not found.");
                return;
            }
        
            const recentSearches = savedSearches.slice(-10); // Get the last 10 searches
            recentTableBody.innerHTML = '';  // Clear the recent searches table
            recentSearches.forEach((procurement, index) => {
                recentTableBody.innerHTML += procurement.generateTableRow(index);
        });
        
        function deleteSearch(index) {
            savedSearches.splice(index, 1);
            updateSavedSearchesTable();
        }

        function editSearch(index) {
            const procurement = savedSearches[index];
            document.getElementById('name').value = procurement.name;
            document.getElementById('cost').value = procurement.cost;
            document.getElementById('procedureType').value = procurement.procedureType;
            document.getElementById('contractSigningDate').value = procurement.contractSigningDate.toISOString().split('T')[0];
            deleteSearch(index);
            closeAllTabs();
            document.getElementById('formContainer').classList.remove('hidden');
            setActiveTab(document.getElementById('showForm'));
        }

        function refreshDuration(index) {
            const procurement = savedSearches[index];
            procurement.procedureDuration = parseInt(document.getElementById('totalDuration').innerText);
            procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();
            document.getElementById('requestSubmissionDate').innerText = formatDate(procurement.requestSubmissionDate);
            updateSavedSearchesTable();
        }

        async function saveHistory() {
            try {
                const response = await fetch('http://localhost:3000/save-history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(history)
                });
                if (!response.ok) {
                    console.error('Failed to save history');
                }
            } catch (error) {
                console.error('Error saving history:', error);
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch('http://localhost:8080/history.json');
                if (response.ok) {
                    const savedHistory = await response.json();
                    console.log('Fetched history:', savedHistory); // Debugging statement
                    history.length = 0; // Clear current history
                    savedHistory.forEach(item => {
                        const procurement = new PublicProcurement(
                            item.name,
                            item.cost,
                            item.procedureType,
                            item.contractSigningDate
                        );
                        procurement.procedureDuration = item.procedureDuration;
                        procurement.procedureDetails = item.procedureDetails;
                        procurement.requestSubmissionDate = item.requestSubmissionDate;
                        history.push(procurement);
                    });
                    updateHistoryTable();
                    populateFilterOptions();
                } else {
                    console.error('Failed to load history:', response.statusText);
                }
            } catch (error) {
                console.error('Error fetching history:', error);
            }
        }

        function updateHistoryTable() {
            const tableBody = document.getElementById('historyTableBody');
            tableBody.innerHTML = '';
            history.forEach((procurement, index) => {
                console.log('Adding row for:', procurement); // Debugging statement
                tableBody.innerHTML += procurement.generateTableRow(index);
            });
            adjustTableColumns();
        }

        function populateFilterOptions() {
            const filterSelect = document.getElementById('filterByDate');
            const dates = [...new Set(history.map(procurement => procurement.contractSigningDate.toISOString().split('T')[0]))];
            filterSelect.innerHTML = '<option value="all">Kõik</option>';
            dates.forEach(date => {
                filterSelect.innerHTML += `<option value="${date}">${date}</option>`;
            });
        }

        document.getElementById('filterByDate').addEventListener('change', function() {
            const selectedDate = this.value;
            const filteredHistory = selectedDate === 'all' ? history : history.filter(procurement => procurement.contractSigningDate.toISOString().split('T')[0] === selectedDate);
            const tableBody = document.getElementById('historyTableBody');
            tableBody.innerHTML = '';
            filteredHistory.forEach((procurement, index) => {
                tableBody.innerHTML += procurement.generateTableRow(index);
            });
            adjustTableColumns();
        });

        document.getElementById('toggleDarkMode').addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');
        });

        function updateDateTime() {
            const now = new Date();
            const dateTimeString = now.toLocaleString('et-EE', { dateStyle: 'full', timeStyle: 'medium' });
            document.getElementById('currentDateTime').innerText = dateTimeString;
        }

        setInterval(updateDateTime, 1000);
        updateDateTime();
        loadHistory();

        function adjustTableColumns() {
            const tables = document.querySelectorAll('table');
            tables.forEach(table => {
                const columns = table.querySelectorAll('th');
                columns.forEach((column, index) => {
                    let maxWidth = 0;
                    const cells = table.querySelectorAll(`td:nth-child(${index + 1})`);
                    cells.forEach(cell => {
                        const cellWidth = cell.offsetWidth;
                        if (cellWidth > maxWidth) {
                            maxWidth = cellWidth;
                        }
                    });
                    column.style.width = `${maxWidth}px`;
                });
            });
        }

        document.getElementById('dropdownButton').addEventListener('click', function() {
            const dropdownMenu = document.getElementById('dropdownMenu');
            dropdownMenu.classList.toggle('hidden');
        });

        document.addEventListener('click', function(event) {
            const dropdownButton = document.getElementById('dropdownButton');
            const dropdownMenu = document.getElementById('dropdownMenu');
            if (!dropdownButton.contains(event.target)) {
                dropdownMenu.classList.add('hidden');
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (darkModeToggle) {
                darkModeToggle.addEventListener('change', function () {
                    document.body.classList.toggle('dark-mode', this.checked);
                    localStorage.setItem('darkMode', this.checked);
                });
        
                if (localStorage.getItem('darkMode') === 'true') {
                    document.body.classList.add('dark-mode');
                    darkModeToggle.checked = true;
                }
            }
        });

        // Show Notification
        function showNotification(message, duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.remove('hidden');
            setTimeout(() => {
                notification.classList.add('hidden');
            }, duration);
        }

        document.getElementById('saveFields').addEventListener('click', function() {
            // Your save logic here
            showNotification('Salvestatud edukalt!');
        });
    
        document.getElementById('refreshFields').addEventListener('click', function() {
            // Your update logic here
            showNotification('Uuendatud edukalt!');
        });

        document.addEventListener("DOMContentLoaded", function () {
            const settingsButton = document.getElementById("settingsButton");
            if (settingsButton) {
                settingsButton.addEventListener("click", function () {
                    closeAllTabs();
                    document.getElementById("settingsContainer").classList.remove("hidden");
                    loadSettings();
                    loadProcedureTypes();
                    setActiveTab(this);
                });
            } else {
                console.error("❌ ERROR: 'settingsButton' not found in the document.");
            }
        });
        
        document.getElementById("toggleChartBtn").addEventListener("click", toggleChart);
    
        function toggleChart() {
            const chartContainer = document.getElementById("chartContainer");
            if (!chartContainer) {
                console.error("❌ Chart container not found!");
                return;
            }
            
            chartContainer.classList.toggle("hidden");

            if (!chartContainer.classList.contains("hidden")) {
                setTimeout(() => {
                    if (document.querySelectorAll("#savedSearchesTableBody tr").length > 0) {
                        renderChart();
                    } else {
                        console.warn("⚠ No saved searches found, chart cannot be displayed.");
                    }
                }, 300);
            }
        }

        function renderChart() {
            const canvas = document.getElementById("procurementChart");
            if (!canvas) {
                console.error("❌ Chart canvas not found!");
                return;
            }

            const ctx = canvas.getContext("2d");

            // Destroy previous chart if it exists
            if (window.procurementChart && typeof window.procurementChart.destroy === 'function') {
                window.procurementChart.destroy();
            }

            // Extract data from savedSearchesTableBody
            const rows = document.querySelectorAll("#savedSearchesTableBody tr");
            const labels = [];
            const costs = [];
            const totalDays = [];

            rows.forEach(row => {
                const columns = row.querySelectorAll("td");
                if (columns.length >= 5) {  // Ensure there are enough columns
                    const name = columns[0].innerText.trim();
                    const cost = parseFloat(columns[2].innerText.replace("€", "").trim()); // Remove € sign
                    const days = parseInt(columns[3].innerText.trim(), 10); // Convert to integer

                    if (!isNaN(cost) && !isNaN(days)) { // Ensure valid data
                        labels.push(name);
                        costs.push(cost);
                        totalDays.push(days);
                    }
                }
            });
        }
            
            // If no valid data, show a warning and prevent chart initialization
            if (labels.length === 0) {
                console.warn("⚠ No valid data found for the chart.");
                return;
            }

            // Create the chart
            window.procurementChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: "Menetlusaeg (päevad)",
                            data: totalDays.map(days => {
                                const today = new Date();
                                const submissionDate = new Date();
                                submissionDate.setDate(today.getDate() + days);
                                const timeDiff = submissionDate.getTime() - today.getTime();
                                return Math.ceil(timeDiff / (1000 * 3600 * 24));
                            }),
                            backgroundColor: "rgba(153, 102, 255, 0.6)",
                            borderColor: "rgba(153, 102, 255, 1)",
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: true },
                        tooltip: { enabled: true }
                    }
                }
            });

        // Attach event listeners to navbar buttons
        document.addEventListener("DOMContentLoaded", function () {
            const navTool = document.getElementById("showForm");
            const navHanked = document.getElementById("showSavedSearches");
            const navHistory = document.getElementById("showHistory");
            const navSettings = document.getElementById("settingsButton");

            if (navTool) navTool.addEventListener("click", () => showTab('formContainer'));
            if (navHanked) navHanked.addEventListener("click", () => showTab('savedSearchesContainer'));
            if (navHistory) navHistory.addEventListener("click", () => showTab('historyContainer'));
            
            function showTab(tabId) {
                closeAllTabs();
                document.getElementById(tabId).classList.remove('hidden');
            }
            
            // Initialize Chart.js
            renderChart();
        });
            
        function toggleDashboard() {
            const dashboard = document.getElementById("dashboard");
            const recentCalculationsTable = document.getElementById("recentCalculationsTable");
            
            dashboard.classList.toggle("hidden");
            recentCalculationsTable.classList.toggle("hidden");
            }
        });
    </script>
     
    <script>
        function darkModeHandler() {
            document.body.classList.toggle("dark-mode");
        } // ✅ Correctly closed
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            gsap.from("body", { opacity: 0, duration: 0.3 });
        });
    </script>

    <!-- Dark Mode Handling -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function applyDarkMode(enabled) {
                document.body.classList.toggle('dark-mode', enabled);
                const toggleSwitch = document.getElementById('darkModeToggle');
                if (toggleSwitch) {
                    toggleSwitch.checked = enabled;
                }
            }
    
            function loadDarkMode() {
                const darkModeEnabled = localStorage.getItem('darkMode') === 'true';
                applyDarkMode(darkModeEnabled);
            }
    
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (darkModeToggle) {
                darkModeToggle.addEventListener('change', function () {
                    const isDarkMode = this.checked;
                    localStorage.setItem('darkMode', isDarkMode);
                    applyDarkMode(isDarkMode);
                });
            }
    
            loadDarkMode();
        });
    </script>

<style>
/* Your CSS styles */
</style>

    <style>
    /* Navbar button hover effect */
    .nav-button {
        transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .nav-button:hover {
        background-color: rgba(254, 233, 233, 0.2);
        transform: scale(1.05);
    }
    /* Navbar styling */
    .navbar {
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1rem;
    }
    /* Ensure the clock is fixed in the corner */
    #currentDateTime {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 1000;
    }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    </script>
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="auth.js"></script> <!-- You will create this file next -->
<script>
    // Animated Progression Bars for Procurement Steps (Dynamic Data with Button Trigger)
    // Requires: TailwindCSS, GSAP (Already included in your project)

    document.addEventListener("DOMContentLoaded", function () {
        function animateProgressBars() {
            const bars = document.querySelectorAll(".progress-bar");
            bars.forEach((bar) => {
                gsap.fromTo(bar, 
                    { width: "0%" }, 
                    { width: bar.dataset.progress + "%", duration: 1.5, ease: "power2.out" }
                );
            });
        }

        function extractStepDays() {
            const steps = [
                "Riigihanke alusdokumentide koostamine",
                "Taotluste esitamine RHRis",
                "Pakkumuste esitamine RHRis",
                "Hindamine 1",
                "Otsus 1",
                "Hindamine 2",
                "Otsus 2",
                "Ooteaeg"
            ];
            
            let stepData = [];
            steps.forEach((step, index) => {
                const element = document.getElementById(`days-${index}`);
                if (element) {
                    let days = parseInt(element.innerText.match(/\d+/)?.[0] || "0", 10);
                    stepData.push({ name: step, days: days });
                } else {
                    stepData.push({ name: step, days: 0 });
                }
            });
            return stepData;
        }

        function generateProgressBars() {
            const resultContainer = document.getElementById("result");
            if (!resultContainer || document.getElementById("progressBars")) return;

            const stepData = extractStepDays();
            const totalDays = stepData.reduce((sum, step) => sum + step.days, 0);

            let progressHTML = `<div id='progressBars' class='space-y-4 p-4 bg-white rounded-lg shadow-md mt-4'>`;

            stepData.forEach((step) => {
                const stepProgress = (step.days / totalDays) * 100;
                progressHTML += `
                    <div>
                        <p class='text-gray-700 font-semibold'>${step.name}: ${step.days} päeva</p>
                        <div class='w-full bg-gray-200 rounded-full h-4 overflow-hidden'>
                            <div class='progress-bar bg-blue-500 h-4 rounded-full' data-progress='${stepProgress.toFixed(2)}'></div>
                        </div>
                    </div>
                `;
            });
            progressHTML += `</div>`;

            resultContainer.innerHTML += progressHTML;
            animateProgressBars();
        }

        // Add the button to the "Riigihanke andmed" page as well
        const procurementForm = document.getElementById("procurementForm");
        if (procurementForm) {
            const formButton = document.createElement("button");
            formButton.innerText = "Näita menetluse kulgu";
            formButton.className = "bg-blue-500 text-white px-4 py-2 rounded mt-4 hover:bg-blue-600 transition transform hover:scale-105";
            formButton.addEventListener("click", function(event) {
                event.preventDefault();
                const resultContainer = document.getElementById('result');
                const progressBars = document.getElementById('progressBars');

                if (progressBars) {
                    progressBars.remove();
                } else {
                    const name = document.getElementById('name').value;
                    const cost = parseFloat(document.getElementById('cost').value);
                    const procedureType = document.getElementById('procedureType').value;
                    const contractSigningDate = document.getElementById('contractSigningDate').value;

                    const procurement = new PublicProcurement(name, cost, procedureType, contractSigningDate);
                    resultContainer.innerHTML = procurement.generateHTML();
                    generateProgressBars();
                }
            });
            procurementForm.appendChild(formButton);
        }
    });
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function applyDarkMode(enabled) {
                document.body.classList.toggle('dark-mode', enabled);
                const toggleSwitch = document.getElementById('darkModeToggle');
                if (toggleSwitch) {
                    toggleSwitch.checked = enabled;
                }
            }
        
            function loadDarkMode() {
                const darkModeEnabled = localStorage.getItem('darkMode') === 'true';
                applyDarkMode(darkModeEnabled);
            }
        
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (darkModeToggle) {
                darkModeToggle.addEventListener('change', function () {
                    const isDarkMode = this.checked;
                    localStorage.setItem('darkMode', isDarkMode);
                    applyDarkMode(isDarkMode);
                });
            }
        
            loadDarkMode();
        });
</script>
</body> 
</html>
